
mixin domainSearchInput(domainSearchParams)
  - domainSearchParams                       = domainSearchParams || {};
  - domainSearchParams.actionUrl             = domainSearchParams.actionUrl || "[@T[link:<external linktype='siteurl' path='' parammode='explicit'/>]@T]/api/dpp/search/single";
  - domainSearchParams.cicode                = domainSearchParams.cicode || "";
  - domainSearchParams.icode                 = domainSearchParams.icode || "home:Domain Search:Domains:Domain Search";
  - domainSearchParams.tcode                 = domainSearchParams.tcode || "home:Domain Search:Domains:Domain Search:Search Domain";
  - domainSearchParams.buttonText            = domainSearchParams.buttonText || "[@L[cds.sales/homepage/locales/en:domain-search-btn]@L]";
  - domainSearchParams.placeholderText       = domainSearchParams.placeholderText || "[@L[cds.sales/homepage/segments/default:domain-banner-search-text]@L]";
  - domainSearchParams.formId                = domainSearchParams.formId || "domain-search-form";
  - domainSearchParams.errorModalId          = domainSearchParams.errorModalId || "api-failure";
  - domainSearchParams.domainInputId         = domainSearchParams.domainInputId || "domain-name-input";
  atlantis:webstash(type="css")
    style
      :less
        #domain-name-input { color: #008a32; }
        #domain-name-input::-webkit-input-placeholder { color: #008a32; }
        #domain-name-input:-moz-placeholder { color: #008a32; opacity: 1;  }
        #domain-name-input::-moz-placeholder { color: #008a32; opacity: 1;  }
        #domain-name-input:-ms-input-placeholder { color: #008a32; }
        .search-text { display: none; }
        .search-icon { font-size: 22px; }
        @media (min-width: 768px) {
          .search-text { display: inline; }
          .search-icon { display: none; }
        }
 
  form(id!="#{domainSearchParams.formId}" method="get" action!="#{domainSearchParams.actionUrl}")
    input(type="hidden",name="ci",value=domainSearchParams.cicode)
    input(type="hidden",name="checkAvail",value="1")
    .input-group
      label.searchInput.sr-only(for='domain-name-input') !{domainSearchParams.placeholderText}
      input.headline-primary.searchInput.form-control(id!="#{domainSearchParams.domainInputId}" type='text' placeholder!='#{domainSearchParams.placeholderText}' name='domainToCheck' maxlength='63')
      span.input-group-btn
        button.btn.btn-primary(type='submit' data-ci='#{domainSearchParams.cicode}') 
          span.search-icon.uxicon.uxicon-magnifying-glass
          span.search-text !{domainSearchParams.buttonText}
  script.
    $("##{domainSearchParams.formId}").on('submit', function(e) {
      var input = $("##{domainSearchParams.formId}").find("input[name='domainToCheck']");
      if (input && (input.val() == null || input.val() == "")) {
        e.preventDefault();
        window.location = '[@T[link:<external linktype="siteurl" path="" parammode="explicit"/>]@T]/domains/domain-name-search.aspx';
      }
    });

mixin domainSearchOffersInput(prms)
  - prms                          = prms || {};
  - prms.tlds                     = prms.tlds || ['com','co','org','net'];
  - prms.defaultTld               = prms.defaultTld || 'com';
  - prms.searchNowCallbackFn      = prms.searchNowCallbackFn || "domainSearchFormSubmit"; /* you need to code a function taking the domain name as a string input */
  - prms.maxDomainLength          = prms.maxDomainLength || 63;
  - prms.formId                   = (prms.formId || "domain-search-offers-input").replace(/-/gi,'');
  - prms.title                    = prms.title || "title";
  - prms.cicode                   = prms.cicode || "";
  - prms.placeholderText          = prms.placeholderText || "placeholderText";
  - prms.buttonText               = prms.buttonText || "placeholderText";
  - prms.infoTypeHere             = prms.infoTypeHere || "placeholderText";
  - prms.infoErrorEligibility     = prms.infoErrorEligibility || "placeholderText";
  - prms.infoInvalidTld           = prms.infoInvalidTld || "placeholderText";
    
  form(id!="#{prms.formId}")
    .row
      .col-md-12
        if(prms.title)
          h2.headline-primary.get-a-domain-text !{prms.title}
    .row
      .col-md-12.offer-search-box
          .input-group
            input.form-control.input-lg.search-form-input.searchInput.helveticafont(type="text" placeholder!="#{prms.placeholderText}" name="domainToCheck" autocomplete="off")
            span.input-group-btn
              button.btn.btn-primary.btn-lg.offer-search-btn(type="button" name="searchButton" data-ci="#{prms.cicode}") !{prms.buttonText}
    .row.domain-search-messaging-row
      .col-md-12
        span.search-message.headline-primary.speech-shape-upsidedown.speech-shape-upsidedown-yellow.type-your-business-name !{prms.infoTypeHere}
        span.search-message.headline-primary.speech-shape-upsidedown.speech-shape-upsidedown-orange.domain-eligibility-fail !{prms.infoErrorEligibility}
        span.search-message.headline-primary.speech-shape-upsidedown.speech-shape-upsidedown-orange.invalid-TLD-entered !{prms.infoInvalidTld}
  script.
    #{prms.formId} = {
       executeFnByName: function(name, context) {
        
        var args = [].slice.call(arguments).splice(2);
        var namespaces = name.split(".");
        var func = namespaces.pop();
        for(var i = 0; i < namespaces.length; i++) {
          context = context[namespaces[i]];
        }
        return context[func].apply(this, args);

      },
      validateSubmit: function(e){

        e.preventDefault();
        var domainName = #{prms.formId}.trimmedDomainName(false);
        if((domainName && domainName.length==0) || !domainName) return false;

        domainName = domainName.toLowerCase();
        domainName = #{prms.formId}.formatDomainWithDefaultTldIfNoneSpecified(domainName);
        if(!#{prms.formId}.ensureValidTld(domainName)) {
          return;
        }
        var functionName = '#{prms.searchNowCallbackFn}';
        if(functionName.length > 0)  {
          #{prms.formId}.executeFnByName(functionName, window, e, domainName);
        }

      },
      trimmedDomainName: function(isKeyPress){
        
        var $form = $("##{prms.formId}"),
          $textInput = $form.find('input[name="domainToCheck"]'),
          domainName = $textInput.val();
        if((domainName && domainName.length==0) || !domainName) return null;

        domainName = #{prms.formId}.reformatDomainToValidLength($textInput, domainName, isKeyPress);
        return domainName;

      },
      reformatDomainToValidLength: function($textInput, domain, isKeyPress){

        var idx = domain.indexOf('.'),
            hasTld = idx > -1,
            sld = hasTld ? domain.substring(0, idx) : domain,
            tld = hasTld ? domain.substring(idx+1) : '',
            needsTrimmed = ((idx == -1) ? domain.length > 63 : idx > 63); /* 63 is the magic number for max length of a domain name */        
        sld = needsTrimmed ? sld.substring(0, 63) : sld;
        
        var domainName = sld + ((tld!='') ? '.' + tld : '');
        if(needsTrimmed) {
          $textInput.val(domainName);
        }
        return domainName;

      },
      ensureValidTld: function() {

        var $form = $("##{prms.formId}"),
            $textInput = $form.find('input[name="domainToCheck"]'),
            domainName = $textInput.val(); 
            validTld = #{prms.formId}.hasTldValid(domainName);
        $form.find('.search-message').hide();
        if(validTld) {
          $form.find('.type-your-business-name').show();
        } else {
          $form.find('.invalid-TLD-entered').show();
        }
        return validTld;
        
      },
      hasTldValid: function(domain) {

        domain = $.trim(domain || "");
        var idx = domain.indexOf('.'), isValid = false;
        if(!domain || domain.length == 0 || idx == -1) return true;

        var domainsTld = domain.substring(idx+1).toLowerCase();
        $.each(#{prms.tlds}, function(idx, tld) {
          if(tld.toLowerCase() === domainsTld) {
            isValid = true;
          }
        });
        return isValid

      },
      formatDomainWithDefaultTldIfNoneSpecified: function(domain) {

        if(domain.indexOf('.') > 0) return domain;
        return domain + '.' + #{prms.defaultTld};

      }
    };

    $(document).ready(function(){

      $("##{prms.formId}").on('click', 'button.offer-search-btn', function(){
        $("##{prms.formId}").submit();
      });

      $("##{prms.formId}").on('submit', #{prms.formId}.validateSubmit);
      $("##{prms.formId}").on('keyup', function(e){
        if(e.which == 13) return;
        var domainName = #{prms.formId}.trimmedDomainName(true);
        console.log(domainName);
        if(!domainName || domainName.length == 0) return;
        domainName = #{prms.formId}.formatDomainWithDefaultTldIfNoneSpecified(domainName);
        #{prms.formId}.ensureValidTld(domainName);
      });

    });
    

  atlantis:webstash(type="css")
    style
      :less
        .something {
          font-size: 16px;
        }